name: Auto Build and Release

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  FRAMEWORK_NAME: DooPushSDK

jobs:
  build-and-release:
    runs-on: macos-14  # ä½¿ç”¨ macOS 14 (æ”¯æŒ Xcode 16)
    permissions:
      contents: write  # å…è®¸åˆ›å»ºæ ‡ç­¾å’Œå‘å¸ƒ
      packages: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºç‰ˆæœ¬æ£€æµ‹
          
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'
          
      - name: Cache Xcode DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('Package.swift', 'DooPushSDK.podspec', 'Sources/**/*.swift') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-
            
      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            build
            output
          key: ${{ runner.os }}-build-${{ hashFiles('Package.swift', 'DooPushSDK.podspec', 'Sources/**/*.swift') }}
          restore-keys: |
            ${{ runner.os }}-build-
            
      - name: Extract version from podspec
        id: version
        run: |
          echo "ğŸ” å¼€å§‹æå–ç‰ˆæœ¬å·..."

          if [ -f "DooPushSDK.podspec" ]; then
            echo "âœ… æ‰¾åˆ° DooPushSDK.podspec æ–‡ä»¶"

            # æ˜¾ç¤ºç‰ˆæœ¬ç›¸å…³è¡Œç”¨äºè°ƒè¯•
            echo "ğŸ“‹ podspec ç‰ˆæœ¬è¡Œ:"
            grep -n "spec.version" DooPushSDK.podspec || echo "æœªæ‰¾åˆ° spec.version è¡Œ"

            # æå–ç‰ˆæœ¬å·ï¼ˆæ”¯æŒå•å¼•å·å’ŒåŒå¼•å·ï¼‰
            VERSION=$(grep -E "spec\.version\s*=\s*['\"][^'\"]+['\"]" DooPushSDK.podspec | grep -oE "[0-9]+\.[0-9]+\.[0-9]+" | head -1)

            if [ ! -z "$VERSION" ]; then
              echo "âœ… æ£€æµ‹åˆ°ç‰ˆæœ¬: $VERSION"
              echo "version=$VERSION" >> $GITHUB_OUTPUT
            else
              echo "âŒ æœªèƒ½æå–ç‰ˆæœ¬å·"
              echo "ğŸ“‹ podspec æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
              head -10 DooPushSDK.podspec
              exit 1
            fi
          else
            echo "âŒ æ‰¾ä¸åˆ° DooPushSDK.podspec æ–‡ä»¶"
            echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi
          
      - name: Check if release exists
        id: check_release
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if gh release view "v$VERSION" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ ç‰ˆæœ¬ v$VERSION çš„ Release å·²å­˜åœ¨"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… ç‰ˆæœ¬ v$VERSION æ˜¯æ–°ç‰ˆæœ¬ï¼Œå°†åˆ›å»º Release"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build Framework
        if: steps.check_release.outputs.exists == 'false'
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»º Framework..."
          
          # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
          if [ -f "scripts/build.sh" ]; then
            chmod +x scripts/build.sh
            echo "âœ… æ‰¾åˆ°æ„å»ºè„šæœ¬"
          else
            echo "âŒ æ‰¾ä¸åˆ°æ„å»ºè„šæœ¬ scripts/build.sh"
            exit 1
          fi
          
          # è¿è¡Œæ„å»ºè„šæœ¬å¹¶æ•è·è¾“å‡º
          if ./scripts/build.sh; then
            echo "âœ… Framework æ„å»ºæˆåŠŸ"
          else
            echo "âŒ Framework æ„å»ºå¤±è´¥"
            exit 1
          fi
          
      - name: Verify Framework
        if: steps.check_release.outputs.exists == 'false'
        run: |
          FRAMEWORK_PATH="output/${FRAMEWORK_NAME}.framework"
          if [ -d "$FRAMEWORK_PATH" ]; then
            echo "âœ… Framework æ„å»ºæˆåŠŸ"
            echo "ğŸ“Š Framework ä¿¡æ¯:"
            ls -la "$FRAMEWORK_PATH"
            
            if [ -f "$FRAMEWORK_PATH/$FRAMEWORK_NAME" ]; then
              echo "ğŸ“‹ æ”¯æŒæ¶æ„:"
              lipo -info "$FRAMEWORK_PATH/$FRAMEWORK_NAME" || echo "å•ä¸€æ¶æ„"
            fi
          else
            echo "âŒ Framework æ„å»ºå¤±è´¥"
            exit 1
          fi
          
      - name: Create Framework ZIP
        if: steps.check_release.outputs.exists == 'false'
        run: |
          cd output
          zip -r "${FRAMEWORK_NAME}.framework.zip" "${FRAMEWORK_NAME}.framework"
          echo "âœ… åˆ›å»º ZIP åŒ…: ${FRAMEWORK_NAME}.framework.zip"
          
      - name: Generate Release Notes
        if: steps.check_release.outputs.exists == 'false'
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # è·å–æœ€è¿‘çš„æäº¤è®°å½•
          if git tag | grep -q "v"; then
            LAST_TAG=$(git tag | grep "^v" | sort -V | tail -1)
            COMMITS=$(git log --oneline --no-merges "${LAST_TAG}..HEAD" | head -10)
          else
            COMMITS=$(git log --oneline --no-merges | head -10)
          fi
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          cat > release_notes.md << EOF
          ## DooPushSDK v${VERSION}
          
          ### ğŸ“± Framework ä¿¡æ¯
          - **æœ€ä½æ”¯æŒ**: iOS 12.0+
          - **Xcode ç‰ˆæœ¬**: 16.0+
          - **Swift ç‰ˆæœ¬**: 5.9+
          
          ### ğŸ“¦ é›†æˆæ–¹å¼
          
          #### Framework é›†æˆ
          1. ä¸‹è½½ \`DooPushSDK.framework.zip\`
          2. è§£å‹å¹¶æ‹–æ‹½åˆ° Xcode é¡¹ç›®ä¸­
          3. è®¾ç½®ä¸º "Embed & Sign"
          
          #### Swift Package Manager
          \`\`\`swift
          dependencies: [
              .package(url: "https://github.com/doopush/doopush-ios-sdk.git", from: "${VERSION}")
          ]
          \`\`\`
          
          #### CocoaPods
          \`\`\`ruby
          pod 'DooPushSDK', '~> ${VERSION}'
          \`\`\`
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          EOF
          
          if [ -n "$COMMITS" ]; then
            echo "" >> release_notes.md
            echo "$COMMITS" | sed 's/^/- /' >> release_notes.md
          else
            echo "- åˆå§‹ç‰ˆæœ¬å‘å¸ƒ" >> release_notes.md
          fi
          
          cat >> release_notes.md << EOF
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          - [æ–‡æ¡£](https://docs.doopush.com)
          - [é›†æˆæŒ‡å—](https://docs.doopush.com/sdk/ios-integration)
          - [ç¤ºä¾‹é¡¹ç›®](https://github.com/doopush/doopush-ios-sdk/tree/main/DooPushSDKExample)
          
          ---
          
          **å®Œæ•´å˜æ›´æ—¥å¿—**: https://github.com/doopush/doopush-ios-sdk/compare/${LAST_TAG:-v0.0.0}...v${VERSION}
          EOF
          
          echo "release_notes_file=release_notes.md" >> $GITHUB_OUTPUT
          
      - name: Create Git Tag
        if: steps.check_release.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "ğŸ·ï¸ åˆ›å»º Git æ ‡ç­¾: v$VERSION"
          git config user.name "DooPush Bot"
          git config user.email "bot@doopush.com"
          git tag "v$VERSION"
          git push origin "v$VERSION"
          echo "âœ… Git æ ‡ç­¾åˆ›å»ºæˆåŠŸ"

      - name: Create GitHub Release
        if: steps.check_release.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_NOTES_FILE="${{ steps.release_notes.outputs.release_notes_file }}"

          echo "ğŸ‰ åˆ›å»º Release: DooPushSDK v$VERSION"

          # ç­‰å¾…ä¸€ç§’ç¡®ä¿æ ‡ç­¾å·²åŒæ­¥
          sleep 2

          # ä½¿ç”¨ GitHub CLI åˆ›å»º release å¹¶ä¸Šä¼ æ–‡ä»¶
          gh release create "v$VERSION" \
            --title "DooPushSDK v$VERSION" \
            --notes-file "$RELEASE_NOTES_FILE" \
            --draft=false \
            --prerelease=false \
            "output/${{ env.FRAMEWORK_NAME }}.framework.zip" \
            "DooPushSDK.podspec"

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Update CocoaPods Spec (Optional)
        if: steps.check_release.outputs.exists == 'false' && vars.ENABLE_COCOAPODS_PUBLISH == 'true'
        run: |
          # è¿™éƒ¨åˆ†æ˜¯å¯é€‰çš„ï¼Œéœ€è¦é…ç½® CocoaPods Trunk æƒé™
          echo "âš ï¸ CocoaPods å‘å¸ƒå·²è·³è¿‡ï¼ˆéœ€è¦æ‰‹åŠ¨é…ç½® trunk æƒé™ï¼‰"
          # pod trunk push DooPushSDK.podspec --allow-warnings

      - name: Summary
        if: steps.check_release.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "ğŸ‰ DooPushSDK v$VERSION å‘å¸ƒæˆåŠŸ!"
          echo "ğŸ“¦ Release URL: https://github.com/doopush/doopush-ios-sdk/releases/tag/v$VERSION"
          echo "ğŸ“± Framework: DooPushSDK.framework.zip"
          echo "ğŸ“„ Podspec: DooPushSDK.podspec"
          
      - name: Skip message
        if: steps.check_release.outputs.exists == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "â­ï¸ è·³è¿‡æ„å»º: v$VERSION ç‰ˆæœ¬å·²å­˜åœ¨"
          echo "ğŸ’¡ å¦‚éœ€é‡æ–°å‘å¸ƒï¼Œè¯·ï¼š"
          echo "   1. æ›´æ–°ç‰ˆæœ¬å·åœ¨ DooPushSDK.podspec"
          echo "   2. æˆ–åˆ é™¤ç°æœ‰çš„ Release å’Œ Tag"
